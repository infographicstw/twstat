var fs,fsExtra,bluebird,cheerio,request,iconvLite,requestDebug,YRANGE,CRANGE,root,fetchParams,fetchVars,fetchData,iterateList;fs=require("fs"),fsExtra=require("fs-extra"),bluebird=require("bluebird"),cheerio=require("cheerio"),request=require("request"),iconvLite=require("iconv-lite"),requestDebug=require("request-debug"),YRANGE=17,CRANGE=24,root="http://statdb.dgbas.gov.tw/pxweb",fetchParams=function(){return new bluebird(function(e,t){return request({url:root+"/dialog/CityItemlist_n.asp",encoding:null,method:"GET"},function(r,n,i){var u;return r?t(r+" ( fetch-params )"):(i=iconvLite.decode(new Buffer(i),"big5").split("<td"),u=i.map(function(e){return/<input[^>]+value="([^"]+)"[^>]*>/g.exec(e)}).filter(function(e){return e}).map(function(e){return e[1]}).filter(function(e){return/\d+/.exec(e)}),u.sort(function(e,t){return t>e?1:e>t?-1:0}),e(u))})})},fetchVars=function(e){return new bluebird(function(t,r){return request({url:root+"/dialog/CityDbQuery2Px_n.asp",method:"POST",qsStringifyOptions:{arrayFormat:"repeat"},encoding:null,form:{chkSelTableItem:e||[]}},function(e,n,i){var u,a,o;return e?r(e+" ( fetch-vars )"):(u=iconvLite.decode(new Buffer(i),"big5"),(a=/url=([^']+)/.exec(u))?(o=/ma=([^&]+)&/.exec(a[1]),o?t(o[1]):r("matrxi not parsed ( fetch-vars )")):r("url not parsed ( fetch-vars ) "))})})},fetchData=function(e,t){return new bluebird(function(r,n){var i;return request({url:root+"/Dialog/Saveshow.asp",method:"POST",qsStringifyOptions:{arrayFormat:"repeat"},encoding:null,form:{Valdavarden1:t,Valdavarden2:YRANGE,Valdavarden3:CRANGE,values1:function(){var e,r,n=[];for(e=1,r=t;r>=e;++e)i=e,n.push(i);return n}(),values2:function(){var e,t,r=[];for(e=1,t=YRANGE;t>=e;++e)i=e,r.push(i);return r}(),values3:function(){var e,t,r=[];for(e=1,t=CRANGE;t>=e;++e)i=e,r.push(i);return r}(),matrix:e,root:"../database/CountyStatistics/",classdir:"../database/CountyStatistics/",noofvar:3,elim:"NNN",numberstub:2,lang:9,hasAggregno:0,stubceller:YRANGE*t,headceller:CRANGE,pxkonv:"px"}},function(e,t,i){var u;return e?n(e+" ( fetch-data ) "):(u=iconvLite.decode(new Buffer(i),"big5"),r(u))})})},iterateList=function(e,t,r){var n,i,u,a;return null==t&&(t=null),null==r&&(r=1),e&&e.length?(n=e[0].substring(0,2),n!==t&&(r=1),i=new RegExp("^"+n),u=e.filter(function(e){return i.exec(e)}),e=e.filter(function(e){return!i.exec(e)}),u.length>50&&(a=u.splice(0,50),e=a.concat(e)),console.log("remaining "+e.length+" index, deal with "+n+" type ( "+u.length+" in total )"),fetchVars(u).then(function(e){return fetchData(e,u.length)}).then(function(t){return fsExtra.mkdirs("raw/county"),fs.writeFileSync("raw/county/"+n+("-"+r)+".px",t),iterateList(e,n,r+1)})["catch"](function(e){return console.log("failed due to ",e)})):void console.log("finished.")},fetchParams().then(function(e){return iterateList(e)})["catch"](function(e){return console.log("failed due to ",e)});