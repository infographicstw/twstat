var x$;x$=angular.module("twstat",[]),x$.controller("twstatList",["$scope","$http"].concat(function(t,e){var n,a,i;return t.vizs=document.getElementById("vizs"),t.pal=d3.scale.category20(),t.city5=["高雄市","臺北市","臺中市","臺南市","新北市"],n=d3.select("div.legends").selectAll("div.legend").data(t.city5),n.enter().append("div").attr({"class":"legend"}).each(function(){var e;return e=d3.select(this),e.append("div").attr({"class":"mark"}).style({background:function(e){return t.pal(e)}}),e.append("span").text(function(t){return t})}),e({url:"csv/county/index/index.json",method:"GET"}).success(function(e){return t.csvs=e.map(function(t){return{name:t.replace(/\.csv$/,"")}})}),t.limitscroll=function(t){var e;return e=function(t){return t.stopPropagation(),t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1,!1},t.addEventListener("mousewheel",function(t){var n,a,i,r,s,o,l;return n=this.getBoundingClientRect(),a=n.height,i={height:this.scrollHeight,top:this.scrollTop},i.height<=a?void 0:(r=t.deltaY,s=!1,o=!1,!t.target||"field-agent"!==t.target.id&&"field-agent"!==t.target.parentNode.id||(l=[!0,!0],o=l[0],s=l[1]),o?$(this).scrollTop(i.top+t.deltaY):-t.deltaY>i.top?($(this).scrollTop(0),s=!0):t.deltaY>0&&i.height-a-i.top<=0&&(s=!0),s?e(t):void 0)})},t.items=document.getElementById("items"),t.limitscroll(t.items),t.mobile=window.innerWidth<640?!0:!1,a=t.items.getBoundingClientRect(),i=window.innerHeight-a.top-120,t.mobile&&(i=240),t.yaxisWidth=t.mobile?30:100,$(t.items).css({height:i+"px"}),t.vizs=document.getElementById("vizs"),t.limitscroll(t.vizs),a=t.vizs.getBoundingClientRect(),i=window.innerHeight-a.top-120,t.mobile&&(i=240),$(t.vizs).css({height:i+"px"}),t.update=function(e){return d3.csv("csv/county/index/"+e.name+".csv",function(n){return t.$apply(function(){var a,i,r,s,o,l,c;return e.svg=d3.select("#vizs").append("svg"),e.svg.attr({width:"100%",height:"200px"}),a=e.svg[0][0].getBoundingClientRect(),i={width:a.width,height:a.height},r=i.width,s=i.height,e.svg.attr({viewBox:"0 0 "+r+" "+s,opacity:1}),e.data=n,e.data.forEach(function(t){var e,n,a=[];for(e in t)n=t[e],a.push(t[e]=isNaN(parseFloat(t[e]))?0:parseFloat(t[e]));return a}),e.keys=function(){var t,n=[];for(o in t=e.data[0])l=t[o],n.push(o);return n}().filter(function(t){return"年度"!==t}),e.yearrange=d3.extent(e.data.map(function(t){return parseInt(t["年度"])})),e.valuerange=d3.extent(e.data.map(function(e){return t.city5.map(function(t){return e[t]})}).reduce(function(t,e){return t.concat(e)},[])),e.parsed=e.keys.map(function(t){return{name:t,data:e.data.map(function(e){var n;return n=parseFloat(e[t]),isNaN(n)&&(n=0),{year:e["年度"],value:n}})}}),e.svg.append("text").text(e.name).attr({"class":"title",transform:"translate("+r/2+",190)","font-size":"0.9em","font-weight":"900","text-anchor":"middle","dominant-baseline":"central"}),e.xaxisGroup=e.svg.append("g").attr({"class":"axis horizontal"}),e.yaxisGroup=e.svg.append("g").attr({"class":"axis vertical"}),e.yscale=d3.scale.linear().domain(e.valuerange).range([160,10]),e.xscale=d3.scale.linear().domain(e.yearrange).range([t.yaxisWidth,r-30]),e.xaxis=d3.svg.axis().orient("bottom").scale(e.xscale).ticks(t.mobile?4:10),e.yaxis=d3.svg.axis().orient("left").scale(e.yscale).ticks(4),e.xaxisGroup.call(e.xaxis),e.yaxisGroup.call(e.yaxis),e.xaxisGroup.attr({transform:"translate(0,160)"}),e.yaxisGroup.attr({transform:"translate("+t.yaxisWidth+",0)"}),e.line=d3.svg.line().x(function(t){return e.xscale(t.year)}).y(function(t){return e.yscale(t.value)}),console.log(e.parsed),c=e.svg.selectAll("path.data").data(e.parsed.filter(function(e){return t.city5.indexOf(e.name)>=0})),c.enter().append("path").attr({"class":"data",d:function(t){return e.line(t.data)},stroke:function(e){return t.pal(e.name)},"stroke-width":1,fill:"none"}),c.exit().remove(),t.scrollto(e)})})},t.scrollto=function(e){var n;return n=e.svg[0][0].getBoundingClientRect(),t.vizs.scrollTop=n.top},t.toggle=function(e){return e.active=!e.active,e.data?setTimeout(function(){return e.active?(e.svg.attr({opacity:1}),t.vizs.appendChild(e.svg[0][0]),t.scrollto(e)):e.svg.transition().attr({opacity:0}).each("end",function(){return t.vizs.removeChild(e.svg[0][0])})},0):t.update(e),t.actives=t.csvs.filter(function(t){return t.active})}}));